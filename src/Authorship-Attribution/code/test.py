import numpy as np
from sklearn.cluster import DBSCAN, KMeans
from scipy import stats
def is_abnormal(arr):
    '''检测arr中是否有异常梯度'''
    arr = np.array([i / arr[0] for i in arr]).reshape(-1,1)     # 将第一个元素设置为1
    dbscan = DBSCAN(eps=0.3, min_samples=3)
    dbscan.fit(arr)

    # 获取每个数据点的类别
    labels = dbscan.labels_

    # 找到labels为-1的索引
    index = np.where(labels == -1)[0]
    print(index)
    return 0 in index

filename_pred = \
{'pert_14_2012_1460488_1483485.py': 0.9339509010314941, '2012_1460488_1595491.py': 0.8166406750679016, 'pert_3_2014_2974486_5756407898963968.py': 0.8883170485496521, 'pert_9_2013_2270488_2453486.py': 0.9319111108779907, 'pert_11_2014_2974486_5756407898963968.py': 0.9145576357841492, 'pert_39_2013_2270488_2453486.py': 0.9139028191566467, 'pert_16_2013_2270488_2453486.py': 0.8993719816207886, 'pert_0_2013_2270488_2463486.py': 0.933098554611206, 'pert_35_2013_2270488_2453486.py': 0.9274077415466309, 'pert_21_2014_2974486_5756407898963968.py': 0.8825664520263672, 'pert_26_2012_1460488_1595491.py': 0.9107288718223572, 'pert_31_2013_2270488_2453486.py': 0.9285987019538879, 'pert_28_2012_1460488_1595491.py': 0.8679381012916565, '2012_1460488_1483485.py': 0.7874906659126282, '2013_2270488_2453486.py': 0.8565155267715454, 'pert_7_2012_1460488_1483485.py': 0.9086867570877075, 'pert_38_2014_2974486_5709773144064000.py': 0.9154599905014038, 'pert_12_2013_2270488_2449486.py': 0.9196258187294006, 'pert_1_2013_2270488_2449486.py': 0.8999372124671936, 'pert_20_2013_2270488_2453486.py': 0.9351618885993958, 'pert_17_2013_2270488_2453486.py': 0.9295647740364075, 'pert_19_2014_2974486_5709773144064000.py': 0.9117960929870605, 'pert_18_2013_2270488_2463486.py': 0.9279724359512329, 'pert_32_2014_2974486_5756407898963968.py': 0.9081313610076904, 'pert_22_2014_2974486_5756407898963968.py': 0.9306609034538269, 'pert_33_2014_2974486_5756407898963968.py': 0.8852220177650452, 'pert_5_2014_2974486_5709773144064000.py': 0.913308322429657, 'pert_24_2013_2270488_2463486.py': 0.9111071228981018, 'pert_6_2014_2974486_5709773144064000.py': 0.941462516784668, 'pert_8_2013_2270488_2453486.py': 0.932324230670929, 'pert_2_2013_2270488_2449486.py': 0.9179650545120239, 'pert_13_2014_2974486_5709773144064000.py': 0.8824855089187622, 'pert_37_2012_1460488_1483485.py': 0.9274212718009949, '2014_2974486_5709773144064000.py': 0.8435084223747253, '2013_2270488_2463486.py': 0.8533541560173035, 'pert_27_2013_2270488_2463486.py': 0.9140995144844055, '2014_2974486_5756407898963968.py': 0.8616976737976074, 'pert_34_2012_1460488_1483485.py': 0.9125360250473022, 'pert_36_2012_1460488_1483485.py': 0.9100930690765381, '2013_2270488_2449486.py': 0.8406934142112732, '2014_2974486_5690574640250880.py': 0.6856981515884399, 'pert_29_2013_2270488_2463486.py': 0.8835140466690063, 'pert_40_2012_1460488_1483485.py': 0.8911282420158386, 'pert_4_2013_2270488_2463486.py': 0.927739679813385, 'pert_10_2012_1460488_1595491.py': 0.9149819016456604, 'pert_30_2012_1460488_1483485.py': 0.898652970790863, 'pert_25_2013_2270488_2449486.py': 0.8619822859764099, 'pert_23_2012_1460488_1595491.py': 0.9122228622436523, 'pert_15_2013_2270488_2463486.py': 0.9295452833175659}
\

for filename, pred in filename_pred.items():
    if 'pert' in filename:
        print(filename, pred)
for filename, pred in filename_pred.items():
    if 'pert' not in filename:
        print(filename, pred)
preds = [float(i) for i in filename_pred.values()]
z = np.abs(stats.zscore(preds))
preds = [preds[i] for i in range(len(preds)) if z[i] < 3]
X = np.array(preds).reshape(-1, 1)
kmeans = KMeans(n_clusters=2, random_state=0).fit(X)

preds_0 = [preds[i] for i in range(len(preds)) if kmeans.labels_[i] == 0]
preds_1 = [preds[i] for i in range(len(preds)) if kmeans.labels_[i] == 1]

preds_0_mean = np.mean(preds_0)
preds_1_mean = np.mean(preds_1)

poisoned_label = preds_1_mean > preds_0_mean
poison_filename = []
for i in range(len(kmeans.labels_)):
    if kmeans.labels_[i] == 1:
        poison_filename.append(list(filename_pred.keys())[i])
print(poison_filename)